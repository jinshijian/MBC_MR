---
title: "MBC_MR"
author: "Jinshi"
date: "2022-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(patchwork)
library(readxl)
ggplot2::theme_set(ggplot2::theme_bw())
library(dplyr)
theme_set(theme_bw())
library(tidyr)
library(ggpubr)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(here)

```

## Creat functions
```{r creat functions}
# function for reading data from excel
read_xlsx <- function(x, n_sheet, n_skip) read_excel(file.path(x), sheet = n_sheet, skip = n_skip)

# creat function do linear regression for each region
lm_model <- function(sdata, var_region){
  lm <- lm(sdata$MBC_change ~ sdata$Temp_change)
  lm_sum <- summary(lm)
  intercept <- lm_sum$coefficients[1,1]
  slope <- lm_sum$coefficients[2,1]
  p_slope <- lm_sum$coefficients[2,4]
  tibble(region = var_region, 
         intercept = intercept,
         slope = slope,
         p_slope = round(p_slope, 3)) -> out
  return (out)  }

# plot world map
word_bkgd <- function (sdata) {
  ggplot(data = sdata) + 
    # geom_polygon(aes(x = long, y = lat , fill = region , group = group, alpha = 0.1), color = "white") + 
    geom_polygon(aes(x = long, y = lat, group = group, alpha = 0.1), color = "white", fill = "gray") + 
    coord_fixed(1.3) +
    theme(axis.text.y   = element_text(size = 12),
          axis.text.x   = element_text(size = 12),
          axis.title.y   = element_text(size = 13, margin = margin(t = 0, r = 12, b = 0, l = 0)),
          axis.title.x   = element_text(size = 13, margin = margin(t = 12, r = 0, b = 0, l = 0)),
          panel.background = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          panel.border = element_rect(colour = "black", fill = NA, size = 1.25))+
    theme(legend.position = "none")+
    scale_x_continuous(name = "Longitude", breaks = seq(-180, 180, 30),
                       labels = seq(-180, 180, 30)) +
    scale_y_continuous(name = "Latitude", limits = c(-60, 90), breaks = seq(-90, 90, 15),
                       labels = seq(-90,90,15))
}

# creat function do linear regression for each longterm experiment
longterm_model <- function(sdata, var_study){
  lm <- lm(sdata$MBC_c ~ sdata$Tannual_del)
  lm_sum <- summary(lm)
  intercept <- lm_sum$coefficients[1,1]
  slope <- lm_sum$coefficients[2,1]
  slope_se <- lm_sum$coefficients[2,2]
  p_slope <- lm_sum$coefficients[2,4]
  tibble(Study = var_study, 
         intercept = intercept,
         slope = slope,
         slope_se = slope_se,
         p_slope = round(p_slope, 3),
         tmin = min(sdata$Tannual_del) %>% round(2),
         tmax = max(sdata$Tannual_del) %>% round(2)) -> out
  return (out)}


# creat function for plotting boots sampling results
RegrressionTest <- function(xmin = -0.75, xmax = 0.5, sdata){
  sdata %>% 
  ggplot(aes(x=slope, y=outslope)) +
  geom_point(alpha = 0.5, col = "gray") +
  # geom_smooth(mapping = aes(x=outslope, y=slope), method = "lm", se = FALSE) +
  labs(x = expression(Rate~of~change~('%'~yr^-1)),
       y = expression(Linear~model~slope~(mmol~kg^-1~degree~C^-1))) +
  geom_vline(xintercept = 0, linetype = "dashed",
             color = "red", size = 1) +
  geom_pointrange(aes(xmin=slope - 2*slope_se, xmax = slope + 2*slope_se), col = "gray") +
  xlim(c(xmin, xmax)) +
  scale_y_continuous(position = "left",
                     breaks = seq(round(min(sdata$outslope), 0),
                                  round(max(sdata$outslope), 0), 0.5))
}

# creat function for plotting boots sampling summary results
RegressionTestSum <- function(xmin = -0.75, xmax = 0.5, sdata){
  sdata %>% 
  select(slope, slope_se) %>% 
  summarize_all(.funs = mean) %>% 
  # rename(Mean = slope) %>% 
  transmute(Scenario = "All",
            Study = "This study",
            Low = slope-2*slope_se,
            Mean = slope,
            High = slope+2*slope_se,
            ID = 1) %>%  
  ggplot(aes(x=Mean, y=ID)) +
  # geom_smooth(method = "lm", se = FALSE) +
  labs(x = expression(Rate~of~change~('%'~yr^-1)),
       y = "") +
  geom_vline(xintercept = 0, linetype = "dotted",
             color = "red", size = 1) +
  geom_point()+
  geom_pointrange(aes(xmin=Low, xmax = High)) +
  xlim(c(xmin, xmax)) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())
}

```

## load data
```{r load data}
resample_lm_output500 = read.csv("../output/resample_lm_output_500_patoine.csv")
resample_lm_output500_comb = read.csv("../output/resample_lm_output_500_combine.csv") 
resample_lm_output500_fjoin = read.csv("../output/resample_lm_output_500_patoine_fjoin.csv")
resample_lm_output500_comb_fjoin = read.csv("../output/resample_lm_output_500_combine_fjoin.csv")

resample_lm_output500_comb$slope %>% mean()
mean(resample_lm_output500_comb$outslope)

Patoine_data <- read_xlsx("../rawdata/Patoine_data_figure5.xlsx", n_sheet=2, n_skip = 0)
Meta_subset <- read_xlsx("../rawdata/Patoine_data_figure5.xlsx", n_sheet=4, n_skip = 0)

mbc_Patoine <- read_excel("../rawdata/glc_cmic_data.xlsx", sheet = 2, skip = 0)
mbc_Patoine %>% 
  mutate(tmean_c = tmean/10-273.15) -> mbc_Patoine

mbc_metadata <- read_excel("../rawdata/MBC_metadata.xlsx", sheet=1, skip = 0)
mbc_metadata %>% 
  mutate(
    MBC_ROM = log(MBC_t/MBC_c)) -> mbc_metadata

# longterm_data_del <- drake::readd(longterm_data_del)
longterm_data_del <- read.csv('../output/longterm_data_del.csv')
mbc_metacsv_ndvi = read.csv("../rawdata/mbc_meta_final2.csv")

```


## spatial map
```{r world map, fig.height=4, fig.width=4}
# Base map - word map
worldMap <- map_data(map = "world")
basemap <- word_bkgd(worldMap)

# plot meta_site
mbc_metadata %>% 
  dplyr::select(Latitude, Longitude) %>% 
  na.omit() %>% 
  count(Latitude, Longitude) ->
  meta_count

## add site legend
size_legend <- tibble(x = rep(170, 4),
                      y = c(45,30,15,0),
                      size = c(2,4,6,8))


# plot meta sites
basemap +
  geom_point(data = meta_count, aes(x = meta_count$Longitude, y = meta_count$Latitude), 
               color = "black", shape = 1, size = meta_count$n, alpha = 1, stroke = 1) +
  geom_point(data = mbc_metadata %>% filter(Paper %in% c(68,69)),
             aes(x = Longitude, y = Latitude),
             color = "blue", shape = 16, size = 3, alpha = 1) +
  geom_point(data = longterm_data_del, aes(x = Longitude, y = Latitude),
             color = "red", shape = 1, size = 2, alpha = 0.75, stroke = 2) +
  # legend
  geom_point(data = tibble(x = rep(-170, 3), y = c(-25, -40, -55), size = 1),
             aes(x, y, size = c(3,3,3))
             , shape = c(1, 16, 1)
             , color = c("black", "blue", "red"), alpha = 1, stroke = 1) +
  annotate("text", x = -160, y = c(-25, -40, -55), 
           label = c("Warming experiment", "Within Patoine et al.", "Long-term sites"),
           size = c(3,3,3), hjust = 0) +
  geom_point(data = size_legend, aes(x, y, size = size)
             , shape = c(1, 1, 1, 1)
             , color = c("black"), alpha = 1, stroke = 1) +
  annotate("text", x = 180, y = c(45,30,15,0), 
           label = c("2", "4", "6", "8"),
           size = c(3,3,3,3), hjust = 0) +
  annotate("text", y=c(36.13,58.44,50.12,42.45,-15.6,-37.8),
           x=c(137.42,-93.48,7.31,116.67,-47.6,175.25),
           label = c("LT1","LT2","LT3","LT4","LT5","LT6"),
           col = "red", vjust = -1) -> site_meta

site_meta

```

## get linear model regression coeffients
```{r get linear model regression coeffients}
bind_rows(
  longterm_model(longterm_data_del %>% filter(PaperID == 68), "68"),
  longterm_model(longterm_data_del %>% filter(PaperID == 69), "69"),
  longterm_model(longterm_data_del %>% filter(PaperID == 70), "70"),
  longterm_model(longterm_data_del %>% filter(PaperID == 71), "71"),
  longterm_model(longterm_data_del %>% filter(PaperID == 72), "72"),
  longterm_model(longterm_data_del %>% filter(PaperID == 73), "73")) -> longterm_output

longterm_output %>% 
  mutate(tmean = (tmin + tmax)/2) -> longterm_output

longterm_output$pch <- c(16,16,16,16,16,16)
longterm_output$col <- rep("red",6)
longterm_output$Low <- longterm_output$slope-2*longterm_output$slope_se
longterm_output$High <- longterm_output$slope+2*longterm_output$slope_se
longterm_output$Study2 <- c(73:68)

longterm_output
```

## plot Figure 1
## replot Patoine et al 2022 figure 5 (Figure 1-version2) use ggplot
```{r}
# panel 1 ---------------------------------------------------------------------------------------
Meta_subset$ID[6] = 1.75
Meta_subset %>% 
  ggplot(aes(x=Mean, y=ID)) +
  geom_point(shape = c(16,16,16,16,16,15), col = c("gray","gray","gray","gray","gray","black"))+
  # geom_smooth(method = "lm", se = FALSE) +
  labs(x = 'LN (response ratio)', y = "") +
  geom_vline(xintercept = 0, linetype = 2, color = "black", size = 1) +
  # geom_hline(yintercept = c(2,1), linetype = 1, color = "black", size = 0.5) +
  annotate("rect", xmin = -0.4, xmax = 0.3, ymin = 1.25, ymax = 2.25, alpha = 0.0) +
  geom_pointrange(aes(xmin=Low, xmax = High), col = "black", alpha = 0.5) +
  geom_hline(yintercept = 2.25, linetype = 3, color = "black", size = 0.5)+
    # xlim(c(-0.2, 0.2)) +
  geom_point(aes(x=-0.01005034, y=1.75), shape = 15, size = 3.5)+
  scale_y_continuous(position = "left", breaks = c(Meta_subset$ID,1), labels = c(Meta_subset$Subgroup,"")) +
  theme(axis.title.y = element_blank())  -> panel_meta

# panel 2 ---------------------------------------------------------------------------------------
xmin <- c(longterm_output$Low[1:5],-0.65)
longterm_output %>% 
  ggplot(aes(x=slope, y=Study2)) +
  geom_point(alpha = 0.5, col = "red") +
  # geom_smooth(method = "lm", se = FALSE) +
  labs(x = expression(Linear~model~slope~(mmol~kg^-1~degree~C^-1)), y = "") +
  geom_vline(xintercept = 0, linetype = 2,
             color = "black", size = 1) +
  geom_pointrange(aes(xmin=xmin,  xmax = High), col = "red") +
  geom_segment(aes(x=-0.8, y=68, xend=-0.70, yend=68), col = "red") +
  geom_segment(aes(x=-0.7, y=67.5, xend=-0.7, yend=68), col = "red") +
  geom_segment(aes(x=-0.65, y=68.5, xend=-0.65, yend=68), col = "red") +
  geom_segment(aes(x=-0.7, y=67.5, xend=-0.65, yend=68.5), col = "red") +
  # xlim(c(-0.8, 0.3)) +
  scale_y_continuous(position = "right",
                     breaks = c(68:73) ,labels = c("LT6", "LT5", "LT4", "LT3", "LT2", "LT1")) +
  theme(axis.title.y = element_blank()) -> panel_LT

panel_meta
panel_LT

site_meta + (panel_meta + panel_LT) +
  plot_layout(heights = c(2, 1.5)) +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag.position = c(0.02, 1.01), plot.tag = element_text(vjust = 2)) &
  theme(plot.tag = element_text(size = 15, hjust = -2, vjust = 0, face = "bold"))

# cowplot::plot_grid(panel_LT, panel_meta, labels = c("b", "c"))

# ggsave(here("output/figures", "site_meta_longterm.png"), width = 8, height = 8)

```


## Plot FigrueS 2 
```{r panel 3}
# plot MBC change vs warming magnitude
lm(mbc_metadata$MBC_ROM ~ mbc_metadata$Magnitude_W + I(mbc_metadata$Magnitude_W^2)) %>% summary() -> meta_lm_summary
tibble(a = meta_lm_summary$coefficients[1,1],
       b = meta_lm_summary$coefficients[2,1],
       c = meta_lm_summary$coefficients[3,1]) -> meta_nls_coef

# y_max appear at
mbc_metadata %>% 
  ggplot(aes(Magnitude_W, MBC_ROM)) +
  geom_point(aes(size = MBC_c_n), alpha = 0.5) +
  geom_point(data = mbc_metadata %>% filter(Paper %in% c(68,69)),
             aes(size = MBC_c_n), alpha = 1.0, col = "blue") +
  geom_point(data = mbc_metadata %>% filter(Paper %in% c(0)),
             aes(size = MBC_c_n), alpha = 1, col = "black") +
  # geom_smooth() +
  stat_function(fun = function(x) {meta_nls_coef$a + meta_nls_coef$b*x + meta_nls_coef$c*x^2},
                col = "black", size = 2)+
  geom_vline(xintercept = -meta_nls_coef$b/(2*meta_nls_coef$c), linetype=3, 
                color = "red", size=1) +
  scale_y_continuous(labels = function(x) sprintf("%.2f", x)) +
  labs(x = expression(Warming~magnitude~(degree~C)),
       y = expression(LN~(RR))) +
  theme(legend.title=element_blank(),
        panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA),
        legend.background = element_rect(fill='transparent'), #transparent legend bg
        legend.position = c(0.80, 0.775)) +
  annotate("text", x = 1, y = -0.9, col = "black", hjust = 0,
           label = expression("y="~"-0.38+0.42x-0.08x"^2~(R[adj]^2~"=0.23, p<0.01"))) -> panel_quadratic

## test simple liear regression and plot
mbc_Patoine$tmean_c %>% min()
mbc_Patoine$tmean_c %>% max()
lm(mbc_Patoine$Cmic ~ mbc_Patoine$tmean_c) %>%summary()

mbc_Patoine %>% 
  ggplot(aes(tmean_c, Cmic)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = expression(Mean~annual~temperature~(degree~C)),
       y = expression(MBC~(mmol~kg^-1))) +
  annotate("text", x = -2.5, y = 720, col = "blue", hjust = 0,
           label = expression("y="~'91.20-2.89x'~(R[adj]^2~"=0.04, p<0.01, n=762"))) -> panel_slr_v3


panel_quadratic/panel_slr_v3 +
  plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(size = 20, hjust = -2, vjust = 0, face = "bold"))

# ggsave(here("output/figures", "Figure_quadratic_v2.png"), width = 8, height = 8)
```


## test linear regression
```{r}
# 500 resample
summary(lm(resample_lm_output500$outslope ~ resample_lm_output500$slope))
summary(lm(resample_lm_output500_comb$outslope ~ resample_lm_output500_comb$slope))

# 500 resample with fjoin mask
summary(lm(resample_lm_output500_fjoin$outslope ~ resample_lm_output500_fjoin$slope))
summary(lm(resample_lm_output500_comb_fjoin$outslope ~ resample_lm_output500_comb_fjoin$slope))


```
 


## plot outslope (slope between MAT and MBC across patial sites) vs Slope (MBC trend)
```{r}
resample_lm_output500 %>% 
  ggplot(aes(x=outslope, y=slope)) +
  geom_point(alpha = 0.5, col = "gray") +
  labs(x = expression(Linear~model~slope~(mmol~kg^-1~degree~C^-1)),
       y = expression(Rate~of~change~('%'~yr^-1))) +
  geom_hline(yintercept = 0, linetype = "dashed",
             color = "red", size = 1) +
  geom_pointrange(aes(ymin=slope - 2*slope_se, ymax = slope + 2*slope_se), col = "gray") +
  geom_smooth(mapping = aes(x=outslope, y=slope), method = "lm", se = T)
```


```{r}
# creat function for plotting boots sampling results
RegrressionTest2 <- function(ymin, ymax, sdata){
  sdata %>% 
    ggplot(aes(x=outslope, y=slope)) +
    # geom_point(alpha = 0.5, col = "gray", size = 0.5, shape = 1) +
    labs(x = expression(Linear~model~slope~(mmol~kg^-1~degree~C^-1)),
         y = expression(Rate~of~change~('%'~yr^-1))) +
    geom_hline(yintercept = 0, linetype = "dashed",
               color = "red", size = 1) +
    geom_pointrange(aes(ymin=slope - 2*slope_se, ymax = slope + 2*slope_se),
                    col = "gray", size = 0.25) +
    ylim(c(ymin, ymax)) +
    geom_smooth(mapping = aes(x=outslope, y=slope),
                method = "lm", se = TRUE, col = "black", fill = "black")}


# creat function for plotting boots sampling summary results
RegressionTestSum2 <- function(ymin, ymax, sdata1, sdata2){
  bind_rows(
      sdata1 %>% 
        select(slope, slope_se) %>% 
        summarize_all(.funs = mean) %>% 
        # rename(Mean = slope) %>% 
        transmute(Scenario = "All",
                  Study = "This study",
                  Low = slope-2*slope_se,
                  Mean = slope,
                  High = slope+2*slope_se,
                  ID = 1),
      sdata2) %>%  
    ggplot(aes(x=ID, y=Mean)) +
    labs(y = "", x = "") +
    geom_hline(yintercept = 0, linetype = "dotted",
               color = "red", size = 1) +
    geom_point()+
    geom_pointrange(aes(ymin=Low, ymax = High)) +
    ylim(c(ymin, ymax)) +
    xlim(c(0.5, 2.5)) +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())}

# creat function for summary linear model outputs
sum_slope <- function(sdata, ID, Scenario, n){
  sdata %>% 
    select(slope, outslope, slope_p, slope_se) %>% 
    summarize_all(.funs = mean) %>% 
    # rename(Mean = slope) %>% 
    transmute(ID = ID,
              Scenario = Scenario,
              Slope_MAT_MBC = outslope,
              Rate_of_change = slope,
              slope_p = slope_p,
              slope_se = slope_se,
              n = n)}

```


## get model outputs summary
```{r}

sum_slope (resample_lm_output500, ID = 1, "500_patoine", n = nrow(resample_lm_output500))

lm(mbc_Patoine$Cmic ~ mbc_Patoine$tmean_c) -> patoine_mbc_mat_lm
patoine_mbc_mat_lm$coefficients[2] -> patoine_mbc_mat_lm_slope

Patoine_data$Low[1] -> patoine_low
Patoine_data$High[1] -> patoine_high
Patoine_data$Mean[1] -> patoine_mean

```

## scenario 1 (with vary masks)
```{r patoine run}
RegrressionTest2(sdata = resample_lm_output500,
                 ymin = -0.65, ymax = 0.1) -> plot_patoine

plot_patoine +
  geom_point(aes(x = -2.9613, y = -0.1434), col = "black", size = 2) +
  geom_segment(aes(x = -2.9613, y = -0.1434-2*0.06759, xend = -2.9613, yend = -0.1434+2*0.06759),
               col = "black", size = 1) -> plot_patoine

# get the linear regression between rate_of_change and outslope
summary(lm(resample_lm_output500$slope ~ resample_lm_output500$outslope))

plot_patoine +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) +
  annotate("text", x = -5, y = -0.6, label = expression("Slope = 0.047, "~R^{2}~" = 0.38, p < 0.01"),
           hjust = 0, angle = 0) -> plot_patoine

# add legend
plot_patoine + 
  geom_segment(aes(x = -2.25, y = -0.45, xend = -1.75, yend = -0.45),
               col = "black", size = 1) +
  geom_point(aes(x = -2.0, y = -0.45), col = "black", size = 2.5) +
  geom_segment(aes(x = -2.25, y = -0.55, xend = -1.75, yend = -0.55),
               col = "blue", size = 1) +
  geom_point(aes(x = -2.0, y = -0.55), col = "blue", size = 2.5) +
  annotate("text", x = -1.5, y = -0.45, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -1.5, y = -0.55, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  plot_patoine

plot_patoine

```


## scenario 2 (combine run with vary masks)
```{r}
resample_lm_output500_comb$slope %>% mean()
resample_lm_output500_comb$outslope %>% mean()
sum_slope (resample_lm_output500_comb, ID = 2, "500_combine", n = nrow(resample_lm_output500_comb))
```


```{r combine run}
RegrressionTest2(sdata = resample_lm_output500_comb,
                 ymin = -0.45, ymax = 0.2) -> plot_combine

# get reression 
summary(lm(resample_lm_output500_comb$slope ~ resample_lm_output500_comb$outslope))

plot_combine +
  geom_point(aes(x = -4.6070, y = -0.0920), col = "black", size = 2) +
  geom_segment(aes(x = -4.6070, y = -0.0920-2*0.0588, xend = -4.6070, yend = -0.0920+2*0.0588),
               col = "black", size = 1) +
  annotate("text", x = -7.5, y = -0.4,
           label = expression("Slope = 0.006, "~R^{2}~" = 0.03, p = 0.01"),
           hjust = 0, angle = 0) -> plot_combine


# add results for a signle run
# plot_combine +
#   geom_point(aes(x = -4.6434, y = -0.1261), col = "blue", size = 2) +
#   geom_segment(aes(x = -4.6434,  y= -0.1261-2*0.0526, xend = -4.6434, yend = -0.1261+2*0.0526),
#                col = "blue", size = 1) -> plot_combine

# add results for patoine
plot_combine +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) +
  annotate("text", x = -5, y = -0.6, label = expression("Slope = 0.05, "~R^{2}~" = 0.38, p < 0.01"),
           hjust = 0, angle = 0) -> plot_combine

# add legend
plot_combine + 
  geom_segment(aes(x = -3.7, y = -0.33, xend = -3.0, yend = -0.33),
               col = "black", size = 1) +
  geom_point(aes(x = -3.35, y = -0.33), col = "black", size = 2.5) +
  geom_segment(aes(x = -3.7, y = -0.4, xend = -3.0, yend = -0.4),
               col = "blue", size = 1) +
  geom_point(aes(x = -3.35, y = -0.4), col = "blue", size = 2.5) +
  annotate("text", x = -2.75, y = -0.33, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -2.75, y = -0.4, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  plot_combine

plot_combine

```


## output figure
```{r}
plot_patoine / plot_combine + plot_annotation(tag_levels = "a")
# ggsave(here("output/figures", "resample_m500_200_times.png"), width = 7, height = 7)

```

## now we only include those resamples when p values of lm (MBC ~ MAT) < 0.05
## sub dataset with p < 0.05 for scenario 1 (patoine data)
```{r}
resample_lm_output500_comb %>% 
  filter(slope_p < 0.05) -> sub_resample_lm_output500_comb
summary(lm(sub_resample_lm_output500_comb$slope ~ sub_resample_lm_output500_comb$outslope))

resample_lm_output500 %>% 
  filter(slope_p < 0.05) -> sub_resample_lm_output500
summary(lm(sub_resample_lm_output500$slope ~ sub_resample_lm_output500$outslope))
```

## get model outputs summary
```{r}
sum_slope (sub_resample_lm_output500, ID = 3, "sub_500_patoine",
           n = nrow(sub_resample_lm_output500)) -> sub_patoine_lm_summary

sub_patoine_lm_summary
```
## plot sub_resample_lm_output500
```{r}
RegrressionTest2(sdata = sub_resample_lm_output500,
                 ymin = -0.6,
                 ymax = 0) -> sub_plot_patoine

sub_plot_patoine +
  annotate("text", x = -5, y = -0.58, label = expression("Slope = 0.04, "~R^{2}~" = 0.33, p < 0.01"),
           hjust = 0, angle = 0) -> sub_plot_patoine

sub_plot_patoine +
  geom_point(aes(x = sub_patoine_lm_summary$Slope_MAT_MBC, y = sub_patoine_lm_summary$Rate_of_change),
             col = "black", size = 2) +
  geom_segment(aes(x = sub_patoine_lm_summary$Slope_MAT_MBC,
                   y = sub_patoine_lm_summary$Rate_of_change-2*sub_patoine_lm_summary$slope_se,
                   xend = sub_patoine_lm_summary$Slope_MAT_MBC,
                   yend = sub_patoine_lm_summary$Rate_of_change+2*sub_patoine_lm_summary$slope_se),
               col = "black", size = 1) -> sub_plot_patoine

Patoine_data %>% filter(Scenario == "All" & Study == "Patoine et al.") %>% 
  mutate(ID = 2)

sub_plot_patoine +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) -> sub_plot_patoine

# add legend
sub_plot_patoine + 
  geom_segment(aes(x = -2.75, y = -0.45, xend = -2.25, yend = -0.45),
               col = "black", size = 1) +
  geom_point(aes(x = -2.5, y = -0.45), col = "black", size = 2.5) +
  geom_segment(aes(x = -2.75, y = -0.55, xend = -2.25, yend = -0.55),
               col = "blue", size = 1) +
  geom_point(aes(x = -2.5, y = -0.55), col = "blue", size = 2.5) +
  annotate("text", x = -2.15, y = -0.45, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -2.15, y = -0.55, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  sub_plot_patoine

sub_plot_patoine

```

## ## sub dataset with p < 0.05 for scenario 2 (combine data)
```{r}
sum_slope (sub_resample_lm_output500_comb, ID = 4, "sub_500_combine",
           n = nrow(sub_resample_lm_output500_comb)) 
```


```{r}
RegrressionTest2(sdata = sub_resample_lm_output500_comb,
                 ymin = -0.4,
                 ymax = 0) -> sub_plot_combine

sub_plot_combine +
  annotate("text", x = -7.5, y = -0.38, label = expression("Slope = 0.009, "~R^{2}~" = 0.14, p < 0.01"),
           hjust = 0, angle = 0) -> sub_plot_combine

# get average of all runs
sum_slope (sub_resample_lm_output500_comb, ID = 4, "sub_500_combine", n = 59)

sub_plot_combine +
  geom_point(aes(x = -4.21366, y = -0.12277), col = "black", size = 2) +
  geom_segment(aes(x = -4.21366, y = -0.12277-2*0.0499, xend = -4.21366, yend = -0.12277+2*0.0499),
               col = "black", size = 1) -> sub_plot_combine


# get results from the sinple run 

# add information for patoine
sub_plot_combine +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) -> sub_plot_combine


# add legend
sub_plot_combine + 
  geom_segment(aes(x = -4.0, y = -0.32, xend = -3.0, yend = -0.32),
               col = "black", size = 1) +
  geom_point(aes(x = -3.5, y = -0.32), col = "black", size = 2.5) +
  geom_segment(aes(x = -4.0, y = -0.375, xend = -3.0, yend = -0.375),
               col = "blue", size = 1) +
  geom_point(aes(x = -3.5, y = -0.375), col = "blue", size = 2.5) +
  annotate("text", x = -2.75, y = -0.32, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -2.75, y = -0.375, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  sub_plot_combine


sub_plot_combine

```


## output figure
```{r}
sub_plot_patoine / sub_plot_combine + plot_annotation(tag_levels = "a")

# ggsave(here("output/figures", "resample_m500_200_times_P005.png"), width = 7, height = 7)

```







## plot results for fjoin
## get model outputs summary
```{r}

sum_slope (resample_lm_output500_fjoin, ID = 5, "500_patoine_fjoin",
           n = nrow(resample_lm_output500_fjoin))

```

## scenario 1 (with vary masks)
```{r patoine run}
RegrressionTest2(sdata = resample_lm_output500_fjoin,
                 ymin = -0.65, ymax = 0.1) -> plot_patoine_fjoin

plot_patoine_fjoin +
  geom_point(aes(x = -2.9613, y = -0.2145), col = "black", size = 2) +
  geom_segment(aes(x = -2.9613, y = -0.2145-2*0.09472, xend = -2.9613, yend = -0.2145+2*0.09472),
               col = "black", size = 1) -> plot_patoine_fjoin

# get the linear regression between rate_of_change and outslope
summary(lm(resample_lm_output500_fjoin$slope ~ resample_lm_output500_fjoin$outslope))

plot_patoine_fjoin +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) +
  annotate("text", x = -5, y = -0.6, label = expression("Slope = 0.068, "~R^{2}~" = 0.36, p < 0.01"),
           hjust = 0, angle = 0) -> plot_patoine_fjoin

# add legend
plot_patoine_fjoin + 
  geom_segment(aes(x = -2.25, y = -0.45, xend = -1.75, yend = -0.45),
               col = "black", size = 1) +
  geom_point(aes(x = -2.0, y = -0.45), col = "black", size = 2.5) +
  geom_segment(aes(x = -2.25, y = -0.55, xend = -1.75, yend = -0.55),
               col = "blue", size = 1) +
  geom_point(aes(x = -2.0, y = -0.55), col = "blue", size = 2.5) +
  annotate("text", x = -1.5, y = -0.45, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -1.5, y = -0.55, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  plot_patoine_fjoin

plot_patoine_fjoin

```


## scenario 2 (combine run with vary masks)
```{r}
sum_slope (resample_lm_output500_comb_fjoin, ID = 6, "500_combine",
           n = nrow(resample_lm_output500_comb_fjoin))
```


```{r combine run}
RegrressionTest2(sdata = resample_lm_output500_comb_fjoin,
                 ymin = -0.45, ymax = 0.2) -> plot_combine_fjoin

# get reression 
summary(lm(resample_lm_output500_comb_fjoin$slope ~ resample_lm_output500_comb_fjoin$outslope))

plot_combine_fjoin +
  geom_point(aes(x = -4.6070, y = -0.1206), col = "black", size = 2) +
  geom_segment(aes(x = -4.6070, y = -0.1206-2*0.05, xend = -4.6070, yend = -0.1206+2*0.05),
               col = "black", size = 1) +
  annotate("text", x = -7.5, y = -0.4,
           label = expression("Slope = 0.0119, "~R^{2}~" = 0.088, p < 0.01"),
           hjust = 0, angle = 0) -> plot_combine_fjoin

# add results for patoine
plot_combine_fjoin +
  geom_point(aes(x = patoine_mbc_mat_lm_slope, y = patoine_mean), col = "blue", size = 2) +
  geom_segment(aes(x = patoine_mbc_mat_lm_slope, y = patoine_low,
                   xend = patoine_mbc_mat_lm_slope, yend = patoine_high),
               col = "blue", size = 1) +
  annotate("text", x = -5, y = -0.6, label = expression("Slope = 0.05, "~R^{2}~" = 0.38, p < 0.01"),
           hjust = 0, angle = 0) -> plot_combine_fjoin

# add legend
plot_combine_fjoin + 
  geom_segment(aes(x = -3.7, y = -0.33, xend = -3.0, yend = -0.33),
               col = "black", size = 1) +
  geom_point(aes(x = -3.35, y = -0.33), col = "black", size = 2.5) +
  geom_segment(aes(x = -3.7, y = -0.4, xend = -3.0, yend = -0.4),
               col = "blue", size = 1) +
  geom_point(aes(x = -3.35, y = -0.4), col = "blue", size = 2.5) +
  annotate("text", x = -2.75, y = -0.33, label = "Average", col = "black", hjust = 0) +
  annotate("text", x = -2.75, y = -0.4, label = "Patoine et al.", col = "blue", hjust = 0) -> 
  plot_combine_fjoin

plot_combine_fjoin

```


## output figure
```{r}
plot_patoine_fjoin / plot_combine_fjoin + plot_annotation(tag_levels = "a")
# ggsave(here("output/figures", "resample_m500_200_times_fjoin.png"), width = 7, height = 7)

```







